<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WatchClaw Dashboard</title>
<style>
  :root {
    --bg: #0d1117;
    --surface: #161b22;
    --border: #30363d;
    --text: #c9d1d9;
    --muted: #8b949e;
    --accent: #58a6ff;
    --green: #3fb950;
    --yellow: #d29922;
    --red: #f85149;
    --orange: #d18616;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.5;
  }
  header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 12px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
  }
  header h1 { font-size: 18px; font-weight: 600; }
  header h1 span { color: var(--accent); }
  .header-right { display: flex; align-items: center; gap: 16px; }
  .status { font-size: 12px; color: var(--muted); }
  .status .dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: var(--green); margin-right: 4px; }

  /* Search bar */
  .search-bar {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .search-bar input, .search-bar select {
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 13px;
    outline: none;
  }
  .search-bar input:focus, .search-bar select:focus {
    border-color: var(--accent);
  }
  .search-bar input { width: 200px; }

  .container { max-width: 1400px; margin: 0 auto; padding: 20px 24px; }

  /* Stats row */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
  }
  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    text-align: center;
  }
  .stat-card .stat-value {
    font-size: 28px;
    font-weight: 700;
    font-family: monospace;
  }
  .stat-card .stat-label {
    font-size: 12px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 4px;
  }

  .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
  @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }
  .card-header {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    font-weight: 600;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .card-header .count {
    background: var(--border);
    color: var(--muted);
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 10px;
  }
  .card-body { padding: 0; max-height: 420px; overflow-y: auto; }
  .full-width { grid-column: 1 / -1; }

  /* Action timeline */
  .action-row {
    display: grid;
    grid-template-columns: 140px 80px 100px 1fr 60px;
    gap: 8px;
    padding: 8px 16px;
    border-bottom: 1px solid var(--border);
    font-size: 13px;
    align-items: center;
  }
  .action-row:hover { background: rgba(88,166,255,0.04); }
  .action-row .ts { color: var(--muted); font-family: monospace; font-size: 12px; }
  .action-row .score { font-family: monospace; text-align: right; }

  /* Decision badges */
  .badge {
    display: inline-block;
    padding: 1px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
  }
  .badge-allow { background: rgba(63,185,80,0.15); color: var(--green); }
  .badge-log { background: rgba(139,148,158,0.15); color: var(--muted); }
  .badge-alert { background: rgba(210,153,34,0.15); color: var(--yellow); }
  .badge-escalate { background: rgba(248,81,73,0.15); color: var(--red); }

  /* Alert rows */
  .alert-row {
    padding: 10px 16px;
    border-bottom: 1px solid var(--border);
    font-size: 13px;
  }
  .alert-row:hover { background: rgba(248,81,73,0.04); }
  .alert-row.escalate { border-left: 3px solid var(--red); }
  .alert-row.alert { border-left: 3px solid var(--yellow); }
  .alert-top {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 4px;
  }
  .alert-details {
    font-size: 12px;
    color: var(--muted);
    margin-top: 4px;
  }
  .alert-signals {
    font-size: 11px;
    color: var(--muted);
    margin-top: 2px;
  }
  .alert-signals span { margin-right: 10px; }

  /* Profile cards */
  .profiles-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 12px; padding: 16px; }
  .profile-card {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 12px;
  }
  .profile-card h3 { font-size: 13px; color: var(--accent); margin-bottom: 8px; word-break: break-all; }
  .profile-card .stat { display: flex; justify-content: space-between; font-size: 12px; padding: 2px 0; }
  .profile-card .stat .label { color: var(--muted); }
  .profile-card .action-bar {
    display: flex;
    gap: 2px;
    margin-top: 8px;
    height: 6px;
    border-radius: 3px;
    overflow: hidden;
  }
  .profile-card .action-bar div {
    height: 100%;
    min-width: 2px;
  }

  /* Top rules */
  .rule-row {
    display: flex;
    justify-content: space-between;
    padding: 6px 16px;
    border-bottom: 1px solid var(--border);
    font-size: 13px;
  }
  .rule-row .rule-id { font-family: monospace; color: var(--accent); }
  .rule-row .rule-count { color: var(--muted); }

  .empty { color: var(--muted); padding: 24px 16px; text-align: center; font-size: 13px; }
  .target { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--muted); }
</style>
</head>
<body>

<header>
  <h1><span>WatchClaw</span> Dashboard</h1>
  <div class="search-bar">
    <input type="text" id="search" placeholder="Search targets, agents...">
    <select id="filter-level">
      <option value="">All levels</option>
      <option value="NORMAL">NORMAL</option>
      <option value="LOG">LOG</option>
      <option value="ALERT">ALERT</option>
      <option value="CRITICAL">CRITICAL</option>
    </select>
    <select id="filter-agent">
      <option value="">All agents</option>
    </select>
  </div>
  <div class="header-right">
    <div class="status"><span class="dot"></span>Auto-refresh 5s</div>
  </div>
</header>

<div class="container">
  <!-- Stats -->
  <div class="stats-row" id="stats-row">
    <div class="stat-card"><div class="stat-value" id="stat-total">0</div><div class="stat-label">Total Actions</div></div>
    <div class="stat-card"><div class="stat-value" id="stat-alerts" style="color:var(--yellow)">0</div><div class="stat-label">Alerts</div></div>
    <div class="stat-card"><div class="stat-value" id="stat-escalations" style="color:var(--red)">0</div><div class="stat-label">Escalations</div></div>
    <div class="stat-card"><div class="stat-value" id="stat-rate">0%</div><div class="stat-label">Alert Rate</div></div>
  </div>

  <!-- Agent Profiles -->
  <div class="card full-width" style="margin-bottom:20px">
    <div class="card-header">Agent Profiles <span class="count" id="profile-count">0</span></div>
    <div class="card-body">
      <div class="profiles-grid" id="profiles"></div>
    </div>
  </div>

  <div class="grid">
    <!-- Action Timeline -->
    <div class="card">
      <div class="card-header">Action Timeline <span class="count" id="action-count">0</span></div>
      <div class="card-body" id="actions"></div>
    </div>

    <!-- Alert Panel -->
    <div class="card">
      <div class="card-header">Alert Panel <span class="count" id="alert-count">0</span></div>
      <div class="card-body" id="alerts"></div>
    </div>
  </div>

  <!-- Top Triggered Rules -->
  <div class="card" style="margin-top:20px">
    <div class="card-header">Top Triggered Rules</div>
    <div class="card-body" id="top-rules"></div>
  </div>
</div>

<script>
const API = '';
let knownAgents = new Set();

function badgeClass(decision) {
  return 'badge badge-' + (decision || 'allow').toLowerCase();
}

function shortTs(iso) {
  if (!iso) return '?';
  const d = new Date(iso);
  return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
}

function truncate(s, n) {
  if (!s) return '';
  return s.length > n ? s.slice(0, n) + '...' : s;
}

function esc(s) {
  if (!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

async function fetchJSON(url) {
  try {
    const r = await fetch(url);
    if (!r.ok) return null;
    return await r.json();
  } catch { return null; }
}

const ACTION_COLORS = {
  file_read: '#58a6ff',
  file_write: '#3fb950',
  exec: '#f85149',
  web_fetch: '#d29922',
  tool_call: '#8b949e',
  message_send: '#bc8cff',
};

function getSearchTerm() {
  return (document.getElementById('search').value || '').toLowerCase();
}
function getFilterLevel() {
  return document.getElementById('filter-level').value;
}
function getFilterAgent() {
  return document.getElementById('filter-agent').value;
}

function filterEntries(entries) {
  const search = getSearchTerm();
  const level = getFilterLevel();
  const agent = getFilterAgent();
  return entries.filter(a => {
    const e = a.event || {};
    const an = a.anomaly || {};
    if (level && an.decision !== level) return false;
    if (agent && e.agent_id !== agent) return false;
    if (search) {
      const hay = ((e.target||'') + ' ' + (e.agent_id||'') + ' ' + (e.action_type||'')).toLowerCase();
      if (!hay.includes(search)) return false;
    }
    return true;
  });
}

async function refresh() {
  // Stats
  const stats = await fetchJSON(API + '/api/stats');
  if (stats) {
    document.getElementById('stat-total').textContent = stats.total;
    document.getElementById('stat-alerts').textContent = stats.alerts;
    document.getElementById('stat-escalations').textContent = stats.escalations;
    document.getElementById('stat-rate').textContent = (stats.alert_rate * 100).toFixed(1) + '%';

    // Top rules
    const rulesEl = document.getElementById('top-rules');
    if (stats.top_rules && stats.top_rules.length > 0) {
      rulesEl.innerHTML = stats.top_rules.map(r =>
        `<div class="rule-row"><span class="rule-id">${esc(r.id)}</span><span class="rule-count">${r.count} hits</span></div>`
      ).join('');
    } else {
      rulesEl.innerHTML = '<div class="empty">No rules triggered yet</div>';
    }
  }

  // Actions
  const actions = await fetchJSON(API + '/api/actions?limit=100');
  const actionsEl = document.getElementById('actions');
  if (actions) {
    const filtered = filterEntries(actions);
    document.getElementById('action-count').textContent = filtered.length;
    if (filtered.length === 0) {
      actionsEl.innerHTML = '<div class="empty">No actions recorded yet. Start engine with: watchclaw start --simulate</div>';
    } else {
      actionsEl.innerHTML = filtered.slice().reverse().map(a => {
        const e = a.event || {};
        const an = a.anomaly || {};
        return `<div class="action-row">
          <span class="ts">${shortTs(e.ts)}</span>
          <span class="${badgeClass(an.decision)}">${an.decision || '?'}</span>
          <span>${esc(e.action_type || '?')}</span>
          <span class="target" title="${esc(e.target)}">${esc(truncate(e.target, 50))}</span>
          <span class="score">${(an.score||0).toFixed(2)}</span>
        </div>`;
      }).join('');
    }
  }

  // Alerts
  const alerts = await fetchJSON(API + '/api/alerts?limit=50');
  const alertsEl = document.getElementById('alerts');
  if (alerts) {
    const filtered = filterEntries(alerts);
    document.getElementById('alert-count').textContent = filtered.length;
    if (filtered.length === 0) {
      alertsEl.innerHTML = '<div class="empty">No alerts yet</div>';
    } else {
      alertsEl.innerHTML = filtered.slice().reverse().map(a => {
        const e = a.event || {};
        const an = a.anomaly || {};
        const v = a.verdict;
        const cls = (an.decision === 'CRITICAL') ? 'escalate' : 'alert';
        const signals = (an.signals || []).slice(0, 3);
        const signalHtml = signals.map(s =>
          `<span><b>${esc(s.name)}</b>: ${(s.value||0).toFixed(2)} (w=${(s.weight||1).toFixed(1)})</span>`
        ).join('');
        const verdictHtml = v ? `<div style="margin-top:2px;color:var(--orange)">Verdict: ${esc(v.verdict)} (${(v.confidence*100).toFixed(0)}%) - ${esc(v.reason)}</div>` : '';
        return `<div class="alert-row ${cls}">
          <div class="alert-top">
            <span class="ts">${shortTs(e.ts)}</span>
            <span class="${badgeClass(an.decision)}">${an.decision}</span>
            <span>${esc(e.agent_id || '?')}</span>
            <span>${esc(e.action_type || '?')}</span>
            <span class="score" style="margin-left:auto">${(an.score||0).toFixed(2)}</span>
          </div>
          <div class="target" title="${esc(e.target)}">${esc(truncate(e.target, 80))}</div>
          <div class="alert-signals">${signalHtml}</div>
          ${verdictHtml}
        </div>`;
      }).join('');
    }
  }

  // Profiles
  const profiles = await fetchJSON(API + '/api/profiles');
  const profilesEl = document.getElementById('profiles');
  if (profiles) {
    document.getElementById('profile-count').textContent = profiles.length;

    // Update agent filter dropdown
    profiles.forEach(p => {
      if (!knownAgents.has(p.agent_id)) {
        knownAgents.add(p.agent_id);
        const opt = document.createElement('option');
        opt.value = p.agent_id;
        opt.textContent = p.agent_id;
        document.getElementById('filter-agent').appendChild(opt);
      }
    });

    if (profiles.length === 0) {
      profilesEl.innerHTML = '<div class="empty">No agent profiles yet</div>';
    } else {
      profilesEl.innerHTML = profiles.map(p => {
        const types = p.action_types || {};
        const total = Object.values(types).reduce((a,b) => a+b, 0) || 1;
        const barHtml = Object.entries(types).map(([t, c]) => {
          const pct = (c / total * 100).toFixed(1);
          const color = ACTION_COLORS[t] || '#8b949e';
          return `<div style="width:${pct}%;background:${color}" title="${t}: ${c}"></div>`;
        }).join('');
        const alertRate = p.count > 0 ? ((p.alerts + p.escalations) / p.count * 100).toFixed(1) : '0.0';
        return `<div class="profile-card">
          <h3>${esc(p.agent_id)}</h3>
          <div class="stat"><span class="label">Events</span><span>${p.count}</span></div>
          <div class="stat"><span class="label">Alerts</span><span style="color:var(--yellow)">${p.alerts}</span></div>
          <div class="stat"><span class="label">Escalations</span><span style="color:var(--red)">${p.escalations}</span></div>
          <div class="stat"><span class="label">Alert Rate</span><span>${alertRate}%</span></div>
          <div class="action-bar">${barHtml}</div>
        </div>`;
      }).join('');
    }
  }
}

// Debounced search
let searchTimeout;
document.getElementById('search').addEventListener('input', () => {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(refresh, 300);
});
document.getElementById('filter-level').addEventListener('change', refresh);
document.getElementById('filter-agent').addEventListener('change', refresh);

refresh();
setInterval(refresh, 5000);
</script>
</body>
</html>
